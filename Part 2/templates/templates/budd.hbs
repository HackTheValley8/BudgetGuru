<!DOCTYPE html>
<html lang="en">
    <head>

        <script>var infos;</script>

        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
        <script src="main.js"></script> 
        <link rel="stylesheet" href="/css/budd.css">
        <title>Document</title>
    </head>
<body>
    <button id="addbutton"> + </button>
    <div id="addform" class="float-start">
   <form id="budget-form">
  <!-- Your form fields -->
  <label for="name">Purchased:</label><br>
  <input type="text" id="addform_name" name="content[]"><br>
  <label for="price">Price:</label><br>
  <input type="number" id="addform_price" name="price[]"><br>
  <label for="importance">Importance:</label><br>
  <input type="number" id="addform_importance" name="importance[]"><br><br>

  <input type="submit" value="Submit">
</form>

    </div>
    <div class="row">
        <div class="col-4">
            <div style="width: 150px;" class="bar-container">
            </div>
        </div>
        <div class="col-8">
            <h1>Budget Table</h1>
            <div class="container">
                <table>
                    <tr>
                        <th>Item</th>
                        <th>Price</th>
                        <th>Importance</th>
                    </tr>
                    <!-- Add more items as needed -->
                </table>
            </div>
        </div>
    </div>
    <script>
$(document).ready(function () {
  // ...

  // Define the form submission handler
  $("#budget-form").on("submit", function (event) {
    event.preventDefault();

    // Serialize the form data into a format that can be sent via AJAX
    const formData = $(this).serialize();

    // Send an AJAX POST request to your server endpoint
    $.ajax({
      type: "POST", // HTTP method
      url: "/budget-planner", // Your server endpoint URL
      data: formData, // The form data
      success: function (response) {
        console.log("Data sent to server successfully");
        // Optionally, you can handle the server's response here
      },
      error: function (error) {
        console.error("Error sending data to server:", error);
        // Handle any errors that occur during the AJAX request
      },
    });

    // Clear the form or perform any other necessary actions
    $("#addform_name").val("");
    $("#addform_price").val("");
    $("#addform_importance").val("");
  });

  // ...
});

    </script>





    <script>
        // ... (Your existing JavaScript for bar percentages) ...

        function allowDrop(event) {
            event.preventDefault();
        }

        function drag(event) {
            const itemName = event.target.querySelector('td:first-child').textContent;
            event.dataTransfer.setData("text", itemName);
        }

        function drop(event) {
            event.preventDefault();
            const data = event.dataTransfer.getData("text");
            const totalBudgetTable = document.getElementById("total-budget");
            const newRow = totalBudgetTable.insertRow(-1);
            const newItemCell = newRow.insertCell(0);
            newItemCell.textContent = data;
        }
        $(document).ready(function () {


infos = localStorage.getItem("infosave");
if (infos === null) {
    infos = {
        0: {"name": "groceries", "price": 200, "importance": 8},
        1: {"name": "rent", "price": 600, "importance": 9}
    };
    localStorage.setItem("infosave", JSON.stringify(infos))
} else {
    infos = JSON.parse(infos);
}


function h(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) {
        const c = s.charCodeAt(i);
        h = (h << 5) - h + c;
        h |= 0;
    }
    return h;
}
  
function r(s) {
    return Math.abs(h(s.toString())) % 128;
}

function removeRow(key) {
    const len = Object.keys(infos).length;
    for (var i=key; i<len-1; i++){
        window['infos'][i] = infos[i+1];
    }
    delete infos[len-1];
    reRender();
}

const tableHandler = function(e) {
    const clicked = e.currentTarget;
    const clickedkey = parseInt(clicked.parentElement.parentElement.id.replace("tableitem", ""));

    if (clicked.classList.contains("table_name")) {
        infos[clickedkey]["name"] = clicked.value;
    } else if (clicked.classList.contains("table_price")) {
        infos[clickedkey]["price"] = parseFloat(clicked.value);
    } else if (clicked.classList.contains("table_importance")) {
        infos[clickedkey]["importance"] = parseInt(clicked.value);
    } else if (clicked.classList.contains("table_delete")) {
        removeRow(clickedkey);
    }
    // reRender();  // don't because it cancels focus
    renderBar(infos);
    localSave(infos);
    // result.innerText = e.target.value;
}

function renderTable(infos){
    var table = $(".container table tbody")[0];
    table.innerHTML = "<tr><th>Item</th><th>Price</th><th>Importance</th><th>Delete</th></tr>";

    for (var key in infos){
        const node = document.createElement("tr");
        node.id = "tableitem" + key.toString();
        
        const a = document.createElement("td");
        a.innerHTML = '<input type="text" class="table_name"></input>';
        a.children[0].value = infos[key]["name"];
        const b = document.createElement("td");
        b.innerHTML = '<input type="text" class="table_price"></input>';
        b.children[0].value = infos[key]["price"];
        const c = document.createElement("td");
        c.innerHTML = '<input type="text" class="table_importance"></input>';
        c.children[0].value = infos[key]["importance"];

        const d = document.createElement("td");

        const e = document.createElement("button");
        e.style.background = "#BB4444";
        e.classList = "table_delete";
        e.style.height = "30px";
        e.style.width = "90%";
        e.style.margin = "auto";
        $(e).on("click", tableHandler);

        d.appendChild(e)

        node.appendChild(a);
        node.appendChild(b);
        node.appendChild(c);
        node.appendChild(d);
        
        table.appendChild(node);
    }
    $(".container table tbody input").on("focusout", tableHandler);
}

function renderBar(infos){
    var bar = $(".bar-container")[0];
    bar.innerHTML = "";
    bar.style.backgroundColor = "rgb(240,240,240)";

    for (var key in infos){
        const node = document.createElement("div");

        // higher is more important
        node.style.order = infos[key]["importance"];

        node.id = "baritem" + key.toString();
        node.class = "bar";
        node.innerHTML =`
        <p class="bar_name">${infos[key]["name"]}</p>
        <p class="bar_price">${infos[key]["price"]}</p>
        <p class="bar_importance">${infos[key]["importance"]}</p>
        `;
        node.style.backgroundColor = `rgb(${r(infos[key]["name"])+128}, ${r(infos[key]["price"])+128}, ${r(infos[key]["importance"])+128})`;

        bar.appendChild(node);
    }
}

function localSave(infos) {
    localStorage.setItem("infosave", JSON.stringify(infos));
}
function reRender(){
    renderTable(infos);
    renderBar(infos);
    localSave(infos);
}
reRender();


$("#addbutton").on("click", function(event) {
    $("#addform")[0].style.display = "initial";
});

$("#addform > form").on("submit", function(event) {
    event.preventDefault();

    infos[Object.keys(infos).length] = {
        "name": $("#addform_name")[0].value,
        "price": $("#addform_price")[0].value,
        "importance": $("#addform_importance")[0].value
    }
    $("#addform")[0].style.display = "none";
    reRender();
})




});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>
